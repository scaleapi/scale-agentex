name: Run Agentex Integration Tests

on:
  pull_request:
    paths:
      - "agentex/**"
  push:
    branches:
      - main
    paths:
      - "agentex/**"
  workflow_dispatch:
    inputs:
      commit-sha:
        description: "Commit SHA or branch to test against"
        required: true
        type: string
        default: main

jobs:
  run-integration-tests:
    name: "Run Integration Tests - s000-hello-acp"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.commit-sha || github.ref }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull agent image
        run: |
          echo "ğŸ³ Pulling agent image..."
          docker pull ghcr.io/scaleapi/scale-agentex-python/tutorial-agents/00_sync-000_hello_acp:latest
          echo "âœ… Agent image pulled successfully"

      - name: Start AgentEx services with host access
        working-directory: ./agentex
        run: |
          echo "ğŸš€ Starting AgentEx services with host access override..."
          docker compose -f docker-compose.yml up -d
          echo "â³ Waiting for services to be ready..."
          sleep 30

          echo "ğŸ“‹ Service status:"
          docker compose ps

          echo "ğŸ” Checking AgentEx service health..."
          HEALTH_TIMEOUT=60
          HEALTH_ELAPSED=0

          while [ $HEALTH_ELAPSED -lt $HEALTH_TIMEOUT ]; do
            if curl -s http://localhost:5003/health > /dev/null 2>&1; then
              echo "âœ… AgentEx service is healthy"
              break
            fi
            echo "â³ Waiting for AgentEx health check... (${HEALTH_ELAPSED}s/${HEALTH_TIMEOUT}s)"
            sleep 5
            HEALTH_ELAPSED=$((HEALTH_ELAPSED + 5))
          done

          if [ $HEALTH_ELAPSED -ge $HEALTH_TIMEOUT ]; then
            echo "âŒ AgentEx service health check failed"
            echo "ğŸ“‹ AgentEx service logs:"
            docker compose logs agentex
            exit 1
          fi

      - name: Run agent integration test
        run: |
          echo "ğŸ§ª Running integration test for agent: s000-hello-acp"
          echo "ğŸ³ Using image: ghcr.io/scaleapi/scale-agentex-python/tutorial-agents/00_sync-000_hello_acp:latest"

          # Start the agent container

          docker run -d --name agent-test-s000-hello-acp \
            -e AGENT_NAME=s000-hello-acp \
            -e ACP_URL=http://agent-test-s000-hello-acp:8000 \
            -e ACP_TYPE=sync \
            -e AGENTEX_BASE_URL=http://agentex:5003 \
            -e AGENTEX_API_BASE_URL=http://agentex:5003 \
            -p 8000:8000 \
            --network agentex-network \
            ghcr.io/scaleapi/scale-agentex-python/tutorial-agents/00_sync-000_hello_acp:latest

          echo "â³ Waiting for agent to start..."
          sleep 10

          # Check for "Application startup complete" log message
          echo "ğŸ” Waiting for 'Application startup complete' log message..."
          TIMEOUT=60
          ELAPSED=0

          while [ $ELAPSED -lt $TIMEOUT ]; do
            if docker logs agent-test-s000-hello-acp 2>&1 | grep -q "Application startup complete"; then
              echo "âœ… Agent application has started successfully"
              break
            fi

            echo "â³ Still waiting for startup... (${ELAPSED}s/${TIMEOUT}s)"
            sleep 2
            ELAPSED=$((ELAPSED + 2))
          done

          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "âŒ Timeout waiting for 'Application startup complete' message"
            echo "ğŸ“‹ Container logs:"
            docker logs agent-test-s000-hello-acp
            exit 1
          fi

          # Test connectivity before running main tests
          echo "ğŸ” Testing connectivity to agent..."
          if ! docker exec agent-test-s000-hello-acp curl -s http://localhost:8000/health > /dev/null 2>&1; then
            echo "âš ï¸ Agent health endpoint not responding, checking if agent is listening..."
            docker exec agent-test-s000-hello-acp netstat -tlnp 2>/dev/null || echo "netstat not available"
          fi

          echo "ğŸ” Testing connectivity to AgentEx from agent container..."
          if ! docker exec agent-test-s000-hello-acp curl -s http://agentex:5003/health > /dev/null 2>&1; then
            echo "âŒ Cannot reach AgentEx from agent container"
            echo "ğŸ“‹ AgentEx service logs:"
            cd agentex && docker compose logs --tail=50 agentex
            cd ..
          else
            echo "âœ… Agent can reach AgentEx services"
          fi

          # Show pre-test logs
          echo "ğŸ“‹ Agent logs before testing:"
          docker logs --tail=20 agent-test-s000-hello-acp

          echo "ğŸ“‹ AgentEx logs before testing:"
          cd agentex && docker compose logs --tail=20 agentex
          cd ..

          # Run the test inside the container with explicit exit code handling
          echo "ğŸ§ª Running tests inside the agent container..."
          set +e  # Don't exit on error immediately
          docker exec agent-test-s000-hello-acp python tests/test_agent.py
          TEST_EXIT_CODE=$?
          set -e  # Re-enable exit on error

          # Show post-test logs regardless of outcome
          echo "ğŸ“‹ Agent logs after testing:"
          docker logs --tail=50 agent-test-s000-hello-acp

          echo "ğŸ“‹ AgentEx logs after testing:"
          cd agentex && docker compose logs --tail=50 agentex
          cd ..

          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "âœ… Tests passed successfully"
          else
            echo "âŒ Tests failed with exit code $TEST_EXIT_CODE"
            echo "ğŸ“‹ Full agent logs:"
            docker logs agent-test-s000-hello-acp
            echo "ğŸ“‹ Full AgentEx logs:"
            cd agentex && docker compose logs agentex
            cd ..
            exit 1
          fi

          echo "ğŸ§¹ Cleaning up container..."
          docker rm -f agent-test-s000-hello-acp
