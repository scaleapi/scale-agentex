name: Run Agentex Integration Tests

on:
  workflow_dispatch:
    inputs:
      commit-sha:
        description: "Commit SHA to test against (defaults to main)"
        required: false
        type: string
        default: main

permissions:
  contents: read
  packages: read

jobs:
  # build-images:
  #   name: "Build AgentEx Images"
  #   uses: ./.github/workflows/build-agentex.yml
  #   with:
  #     commit-sha: ${{ inputs.commit-sha || 'main' }}
  #
  pull-agent-images:
    name: "Pull AgentEx Images"
    runs-on: ubuntu-latest
    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Discover and pull agentex-python packages
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "🔍 Discovering packages from agentex-python repo..."

          # Get package names using the API query
          PACKAGES=$(gh api "orgs/scaleapi/packages?package_type=container" --jq '.[] | select(.repository.name == "agentex-python") | .name')

          if [ -z "$PACKAGES" ]; then
            echo "❌ No packages found in agentex-python repo"
            exit 0
          fi

          echo "📦 Found packages:"
          echo "$PACKAGES"

          # Pull each package
          for package in $PACKAGES; do
            echo "🐳 Pulling ghcr.io/scaleapi/$package:latest"
            docker pull "ghcr.io/scaleapi/$package:latest" || echo "⚠️ Failed to pull $package:latest"
          done

      - name: Show pulled images
        run: |
          echo "🐳 Successfully pulled images:"
          docker images | grep "ghcr.io/scaleapi" || echo "No scaleapi images found"

  # run-integration-tests:
  #   name: "Run Integration Tests"
  #   needs: pull-agent-images
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         ref: ${{ inputs.commit-sha || 'main' }}
  #
  #     - name: Login to GitHub Container Registry
  #       uses: docker/login-action@v3
  #       with:
  #         registry: ghcr.io
  #         username: ${{ github.repository_owner }}
  #         password: ${{ secrets.GITHUB_TOKEN }}
  #
  #     - name: Verify available images
  #       run: |
  #         echo "🐳 Available Docker images for testing:"
  #         docker images | grep "ghcr.io/scaleapi" || echo "No scaleapi images available"
  #
  #     - name: Placeholder - Integration Tests
  #       run: |
  #         echo "🧪 Integration tests will run here"
  #         echo "📦 AgentEx Python dependency images are available for testing"
  #         echo "🔄 This is where actual integration test commands should be added"
