name: Run Agentex Integration Tests

on:
  workflow_dispatch:
    inputs:
      commit-sha:
        description: "Commit SHA to test against (defaults to main)"
        required: false
        type: string
        default: main

permissions:
  contents: read
  packages: write

jobs:
  pull-agent-images:
    name: "Pull AgentEx Images"
    runs-on: ubuntu-latest
    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug API Permissions
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸ” Testing API permissions..."

          # Test basic user access
          echo "ğŸ‘¤ Current user:"
          gh api user --jq '.login' || echo "âŒ User API failed"

          # Test organization access
          echo "ğŸ¢ Organization access:"
          gh api orgs/scaleapi --jq '.login' || echo "âŒ Org API failed"

          # Test different package API endpoints
          echo "ğŸ“¦ Testing package API endpoints:"

          echo "1. Basic packages endpoint:"
          gh api "orgs/scaleapi/packages" --jq 'length' || echo "âŒ Basic packages API failed"

          echo "2. Container packages endpoint:"
          gh api "orgs/scaleapi/packages?package_type=container" --jq 'length' || echo "âŒ Container packages API failed"

          echo "3. Public packages endpoint:"
          gh api "orgs/scaleapi/packages?package_type=container&visibility=public" --jq 'length' || echo "âŒ Public packages API failed"

      - name: Discover and pull scale-agentex-python packages
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸ” Discovering packages from scale-agentex-python repo..."

          # First get all packages and save to temp file to avoid shell issues
          gh api "orgs/scaleapi/packages?package_type=container" > /tmp/packages.json

          # Extract packages from scale-agentex-python repo
          PACKAGES=$(cat /tmp/packages.json | jq -r '.[] | select(.repository.name == "scale-agentex-python") | .name')

          if [ -z "$PACKAGES" ]; then
            echo "âŒ No packages found in scale-agentex-python repo"
            echo "ğŸ” Available packages and their repos:"
            cat /tmp/packages.json | jq -r '.[] | "\(.name) -> \(.repository.name // "null")"'
            exit 0
          fi

          echo "ğŸ“¦ Found packages:"
          echo "$PACKAGES"

          # Pull each package
          for package in $PACKAGES; do
            echo "ğŸ³ Pulling ghcr.io/scaleapi/$package:latest"
            docker pull "ghcr.io/scaleapi/$package:latest" || echo "âš ï¸ Failed to pull $package:latest"
          done

      - name: Show pulled images
        run: |
          echo "ğŸ³ Successfully pulled images:"
          docker images | grep "ghcr.io/scaleapi" || echo "No scaleapi images found"

  # run-integration-tests:
  #   name: "Run Integration Tests"
  #   needs: pull-agent-images
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         ref: ${{ inputs.commit-sha || 'main' }}
  #
  #     - name: Login to GitHub Container Registry
  #       uses: docker/login-action@v3
  #       with:
  #         registry: ghcr.io
  #         username: ${{ github.repository_owner }}
  #         password: ${{ secrets.GITHUB_TOKEN }}
  #
  #     - name: Verify available images
  #       run: |
  #         echo "ğŸ³ Available Docker images for testing:"
  #         docker images | grep "ghcr.io/scaleapi" || echo "No scaleapi images available"
  #
  #     - name: Placeholder - Integration Tests
  #       run: |
  #         echo "ğŸ§ª Integration tests will run here"
  #         echo "ğŸ“¦ AgentEx Python dependency images are available for testing"
  #         echo "ğŸ”„ This is where actual integration test commands should be added"
