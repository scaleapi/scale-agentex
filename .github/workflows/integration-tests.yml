name: Run Agentex Integration Tests

on:
  workflow_dispatch:
    inputs:
      commit-sha:
        description: "Commit SHA to test against (defaults to current branch)"
        required: false
        type: string

permissions:
  contents: read
  packages: write

jobs:
  run-integration-tests:
    name: "Run Integration Tests - s000-hello-acp"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.commit-sha || github.ref }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull agent image
        run: |
          echo "ğŸ³ Pulling agent image..."
          docker pull ghcr.io/scaleapi/scale-agentex-python/tutorial-agents/00_sync-000_hello_acp:latest
          echo "âœ… Agent image pulled successfully"

      - name: Start AgentEx services with host access
        working-directory: ./agentex
        run: |
          echo "ğŸš€ Starting AgentEx services with host access override..."
          docker compose -f docker-compose.yml -f docker-compose.host-access.yml up -d
          echo "â³ Waiting for services to be ready..."
          sleep 30
          docker compose ps

      - name: Run agent integration test
        run: |
          echo "ğŸ§ª Running integration test for agent: s000-hello-acp"
          echo "ğŸ³ Using image: ghcr.io/scaleapi/scale-agentex-python/tutorial-agents/00_sync-000_hello_acp:latest"

          # Start the agent container

          docker run -d --name agent-test-s000-hello-acp \
            -e AGENT_NAME=s000-hello-acp \
            -e ACP_URL=http://agent-test-s000-hello-acp:8000 \
            -e ACP_PORT=8000 \
            -e ACP_TYPE=sync \
            -e AGENTEX_BASE_URL=http://agentex:5003 \
            -e AGENTEX_API_BASE_URL=http://agentex:5003 \
            -p 8000:8000 \
            --network agentex-network \
            ghcr.io/scaleapi/scale-agentex-python/tutorial-agents/00_sync-000_hello_acp:latest

          echo "â³ Waiting for agent to start..."
          sleep 10

          # Check for "Application startup complete" log message
          echo "ğŸ” Waiting for 'Application startup complete' log message..."
          TIMEOUT=60
          ELAPSED=0

          while [ $ELAPSED -lt $TIMEOUT ]; do
            if docker logs agent-test-s000-hello-acp 2>&1 | grep -q "Application startup complete"; then
              echo "âœ… Agent application has started successfully"
              break
            fi

            echo "â³ Still waiting for startup... (${ELAPSED}s/${TIMEOUT}s)"
            sleep 2
            ELAPSED=$((ELAPSED + 2))
          done

          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "âŒ Timeout waiting for 'Application startup complete' message"
            echo "ğŸ“‹ Container logs:"
            docker logs agent-test-s000-hello-acp
            exit 1
          fi

      - name: Run agent tests with retry
        run: |
          echo "ğŸ§ª Running pytest tests against the agent..."

          echo "ğŸ”— Testing connectivity from agentex container to agent..."
          echo "ğŸ“¡ From agentex container, try to reach agent:"
          docker exec agentex curl -v http://agent-test-s000-hello-acp:8000
          echo "ğŸ¥ From agentex container, try to reach agent health endpoint:"
          docker exec agentex curl -v http://agent-test-s000-hello-acp:8000/health

          echo "ğŸ”— Testing connectivity from agent container to agentex..."
          echo "ğŸ“¡ From agent container, try to reach agentex:"
          docker exec agent-test-s000-hello-acp curl -v http://agentex:5003
          echo "ğŸ¥ From agent container, try to reach agentex health endpoint:"
          docker exec agent-test-s000-hello-acp curl -v http://agentex:5003/health

          echo "ğŸ”— Testing basic network connectivity (ping)..."
          echo "ğŸ“ Ping from agentex to agent:"
          docker exec agentex ping -c 3 agent-test-s000-hello-acp
          echo "ğŸ“ Ping from agent to agentex:"
          docker exec agent-test-s000-hello-acp ping -c 3 agentex
          MAX_ATTEMPTS=2
          ATTEMPT=1
          SUCCESS=false

          while [ $ATTEMPT -le $MAX_ATTEMPTS ] && [ "$SUCCESS" = false ]; do
            echo "ğŸ“ Test attempt $ATTEMPT/$MAX_ATTEMPTS"

            if docker exec agent-test-s000-hello-acp pytest tests/test_agent.py -v; then
              echo "âœ… Tests passed on attempt $ATTEMPT!"
              SUCCESS=true
            else
              echo "âŒ Tests failed on attempt $ATTEMPT"
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                echo "â³ Waiting 5 seconds before retry..."
                sleep 5
              fi
            fi

            ATTEMPT=$((ATTEMPT + 1))
          done

          if [ "$SUCCESS" = false ]; then
            echo "âŒ All $MAX_ATTEMPTS test attempts failed"
            exit 1
          fi

          echo "ğŸ‰ Agent tests completed successfully!"

      - name: Show agent logs
        if: always()
        run: |
          echo "ğŸ“‹ Agent logs for s000-hello-acp:"
          docker logs agent-test-s000-hello-acp || echo "No logs available"

      - name: Show AgentEx server logs
        if: always()
        run: |
          echo "ğŸ“‹ AgentEx server logs:"
          docker logs agentex || echo "No AgentEx server logs available"

      - name: Cleanup agent container
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up agent container..."
          docker stop agent-test-s000-hello-acp || true
          docker rm agent-test-s000-hello-acp || true

      - name: Cleanup services
        if: always()
        working-directory: ./agentex
        run: |
          echo "ğŸ§¹ Cleaning up services..."
          docker compose -f docker-compose.yml -f docker-compose.host-access.yml down
          docker system prune -f
