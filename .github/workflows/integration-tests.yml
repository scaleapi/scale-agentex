name: Run Agentex Integration Tests

permissions:
  contents: read
  packages: read

on:
  pull_request:
    paths:
      - "agentex/**"
  push:
    branches:
      - main
    paths:
      - "agentex/**"
  workflow_dispatch:
    inputs:
      commit-sha:
        description: "Commit SHA or branch to test against"
        required: true
        type: string
        default: main

jobs:
  discover-agent-images:
    name: "Discover Tutorial Agent Images"
    runs-on: ubuntu-latest
    outputs:
      agent-matrix: ${{ steps.discover.outputs.agent-matrix }}
    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Discover tutorial agent images
        id: discover
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Discovering tutorial agent images from GHCR using gh CLI..."

          # Debug: Test basic API access first
          echo "Testing basic API access..."
          gh api user --jq '.login' || echo "Basic API failed"

          # Try repository-level packages first (more likely to work)
          echo "Fetching packages from scale-agentex-python repository..."
          gh api repos/scaleapi/scale-agentex-python/packages \
            --field package_type=container \
            --jq '.[] | select(.name | contains("tutorial-agents")) | .name' > packages.txt 2>/dev/null || {
            echo "Repository packages failed, trying organization packages..."

            # Fallback to org packages with simpler query
            gh api orgs/scaleapi/packages \
              --field package_type=container \
              --jq '.[] | select(.name | startswith("scale-agentex-python/tutorial-agents/")) | .name' > packages.txt 2>/dev/null || {
              echo "Organization packages also failed, using fallback list..."

          echo "ğŸ“‹ Found tutorial agent packages:"
          cat packages.txt

          # Build agent matrix from discovered packages
          echo "ğŸ”¨ Building agent matrix from discovered packages..."
          AGENT_IMAGES="["

          while IFS= read -r package_name; do
            if [[ -n "$package_name" ]]; then
              echo "Processing package: $package_name"

              # Extract agent name from package (e.g., "00_sync-000_hello_acp")
              agent_dir=$(basename "$package_name")

              # Convert to agent name format (e.g., "s000-hello-acp")
              # Pattern: [digits]_[type]-[digits]_[rest] -> s[digits]-[rest]
              agent_name=$(echo "$agent_dir" | sed -E 's/^[0-9]+_[^-]+-([0-9]+)_(.*)$/s\1-\2/' | tr '_' '-')

              echo "  - Agent dir: $agent_dir"
              echo "  - Agent name: $agent_name"

              # Add to JSON array
              if [[ "$AGENT_IMAGES" != "[" ]]; then
                AGENT_IMAGES+=","
              fi

              AGENT_IMAGES+='{"name":"'$agent_dir'","image":"ghcr.io/scaleapi/'$package_name':latest","agent_name":"'$agent_name'"}'
            fi
          done < packages.txt

          AGENT_IMAGES+="]"  # Close array

          echo "ğŸ“‹ Generated agent matrix:"
          echo "$AGENT_IMAGES" | jq '.'

          # Convert to compact JSON for matrix
          echo "agent-matrix=$(echo "$AGENT_IMAGES" | jq -c '.')" >> $GITHUB_OUTPUT

          # Cleanup
          rm -f packages.txt

  run-integration-tests:
    name: "Run Integration Tests - ${{ matrix.agent.name }}"
    runs-on: ubuntu-latest
    needs: discover-agent-images
    strategy:
      fail-fast: false # Continue testing other agents even if one fails
      matrix:
        agent: ${{ fromJson(needs.discover-agent-images.outputs.agent-matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.commit-sha || github.ref }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull agent image
        run: |
          echo "ğŸ³ Pulling agent image: ${{ matrix.agent.image }}"
          docker pull ${{ matrix.agent.image }}
          echo "âœ… Agent image pulled successfully"

      - name: Start AgentEx services with host access
        working-directory: ./agentex
        run: |
          echo "ğŸš€ Starting AgentEx services..."
          docker compose -f docker-compose.yml up -d

          echo "ğŸ“‹ Initial service status:"
          docker compose ps

          echo "â³ Waiting for database migrations and service initialization..."
          sleep 45  # AgentEx has 30s start_period + time for migrations

          echo "ğŸ” Checking AgentEx service health..."
          HEALTH_TIMEOUT=90
          HEALTH_ELAPSED=0

          while [ $HEALTH_ELAPSED -lt $HEALTH_TIMEOUT ]; do
            if curl -s http://localhost:5003/health > /dev/null 2>&1; then
              echo "âœ… AgentEx health endpoint is responding"
              break
            fi
            echo "â³ Waiting for AgentEx health check... (${HEALTH_ELAPSED}s/${HEALTH_TIMEOUT}s)"
            sleep 5
            HEALTH_ELAPSED=$((HEALTH_ELAPSED + 5))
          done

          if [ $HEALTH_ELAPSED -ge $HEALTH_TIMEOUT ]; then
            echo "âŒ AgentEx service health check failed"
            echo "ğŸ“‹ AgentEx service logs:"
            docker compose logs agentex
            exit 1
          fi

          echo "ğŸ” Verifying AgentEx API endpoints..."
          if curl -s http://localhost:5003/api > /dev/null 2>&1; then
            echo "âœ… AgentEx API endpoints are accessible"
          else
            echo "âŒ AgentEx API endpoints not responding"
            echo "ğŸ“‹ AgentEx service logs:"
            docker compose logs agentex
            exit 1
          fi

          echo "ğŸ“‹ Final service status after health checks:"
          docker compose ps

      - name: Run agent integration test
        run: |
          # Set variables for this agent
          AGENT_NAME="${{ matrix.agent.agent_name }}"
          AGENT_IMAGE="${{ matrix.agent.image }}"
          CONTAINER_NAME="agent-test-${AGENT_NAME}"

          echo "ğŸ§ª Running integration test for agent: ${AGENT_NAME}"
          echo "ğŸ³ Using image: ${AGENT_IMAGE}"

          # Start the agent container
          docker run -d --name "${CONTAINER_NAME}" \
            -e AGENT_NAME="${AGENT_NAME}" \
            -e ACP_URL="http://${CONTAINER_NAME}" \
            -e ACP_PORT=8000 \
            -e ACP_TYPE=sync \
            -e AGENTEX_BASE_URL=http://agentex:5003 \
            -e AGENTEX_API_BASE_URL=http://agentex:5003 \
            -p 8000:8000 \
            --network agentex-network \
            "${AGENT_IMAGE}"

          echo "â³ Waiting for agent to start..."
          sleep 10

          # Check for "Application startup complete" log message
          echo "ğŸ” Waiting for 'Application startup complete' log message..."
          TIMEOUT=60
          ELAPSED=0

          while [ $ELAPSED -lt $TIMEOUT ]; do
            if docker logs "${CONTAINER_NAME}" 2>&1 | grep -q "Application startup complete"; then
              echo "âœ… Agent application has started successfully"
              break
            fi

            echo "â³ Still waiting for startup... (${ELAPSED}s/${TIMEOUT}s)"
            sleep 2
            ELAPSED=$((ELAPSED + 2))
          done

          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "âŒ Timeout waiting for 'Application startup complete' message"
            echo "ğŸ“‹ Container logs:"
            docker logs "${CONTAINER_NAME}"
            exit 1
          fi

          echo "ğŸ” Verifying agent registration with AgentEx..."
          REGISTRATION_TIMEOUT=30
          REGISTRATION_ELAPSED=0

          while [ $REGISTRATION_ELAPSED -lt $REGISTRATION_TIMEOUT ]; do
            AGENT_DATA=$(curl -s http://localhost:5003/api/agents)
            if echo "$AGENT_DATA" | grep -q "${AGENT_NAME}"; then
              echo "âœ… Agent successfully registered with AgentEx"

              # Verify the ACP URL doesn't have double port
              if echo "$AGENT_DATA" | grep -q ":8000:8000"; then
                echo "âŒ Double port detected in agent registration!"
                echo "ğŸ“‹ Agent data:"
                echo "$AGENT_DATA" | jq '.' || echo "$AGENT_DATA"
                exit 1
              else
                echo "âœ… ACP URL correctly formatted (no double port)"
              fi
              break
            fi
            echo "â³ Waiting for agent registration... (${REGISTRATION_ELAPSED}s/${REGISTRATION_TIMEOUT}s)"
            sleep 5
            REGISTRATION_ELAPSED=$((REGISTRATION_ELAPSED + 5))
          done

          if [ $REGISTRATION_ELAPSED -ge $REGISTRATION_TIMEOUT ]; then
            echo "âš ï¸ Agent registration check timeout, proceeding with tests anyway"
            echo "ğŸ“‹ Current agents registered:"
            curl -s http://localhost:5003/api/agents || echo "Failed to query agents"
          fi

          # Test connectivity before running main tests
          echo "ğŸ” Testing connectivity to agent..."
          if ! docker exec "${CONTAINER_NAME}" curl -s http://localhost:8000/health > /dev/null 2>&1; then
            echo "âš ï¸ Agent health endpoint not responding, checking if agent is listening..."
            docker exec "${CONTAINER_NAME}" netstat -tlnp 2>/dev/null || echo "netstat not available"
          fi

          echo "ğŸ” Testing connectivity to AgentEx from agent container..."
          if ! docker exec "${CONTAINER_NAME}" curl -s http://agentex:5003/health > /dev/null 2>&1; then
            echo "âŒ Cannot reach AgentEx from agent container"
            echo "ğŸ“‹ AgentEx service logs:"
            cd agentex && docker compose logs --tail=50 agentex
            cd ..
          else
            echo "âœ… Agent can reach AgentEx services"
          fi

          # Show pre-test logs
          echo "ğŸ“‹ Agent logs before testing:"
          docker logs --tail=20 "${CONTAINER_NAME}"

          echo "ğŸ“‹ AgentEx logs before testing:"
          cd agentex && docker compose logs --tail=20 agentex
          cd ..

          # Run the test inside the container with explicit exit code handling
          echo "ğŸ§ª Running tests inside the agent container..."
          set +e  # Don't exit on error immediately
          docker exec "${CONTAINER_NAME}" pytest tests/test_agent.py -v
          TEST_EXIT_CODE=$?
          set -e  # Re-enable exit on error

          echo "ğŸ” Test exit code: $TEST_EXIT_CODE"

          # Show post-test logs regardless of outcome
          echo "ğŸ“‹ Agent logs after testing:"
          docker logs --tail=50 "${CONTAINER_NAME}"

          echo "ğŸ“‹ AgentEx logs after testing:"
          cd agentex && docker compose logs --tail=50 agentex
          cd ..

          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "âœ… Tests passed successfully"
          else
            echo "âŒ Tests failed with exit code $TEST_EXIT_CODE"
            echo "ğŸ“‹ Full agent logs:"
            docker logs "${CONTAINER_NAME}"
            echo "ğŸ“‹ Full AgentEx logs:"
            cd agentex && docker compose logs agentex
            cd ..
            exit 1
          fi

          echo "ğŸ§¹ Cleaning up container..."
          docker rm -f "${CONTAINER_NAME}"

  # Summary job to ensure the workflow fails if any test fails
  integration-tests-summary:
    name: "Integration Tests Summary"
    runs-on: ubuntu-latest
    needs: [discover-agent-images, run-integration-tests]
    if: always() # Run even if some tests fail
    steps:
      - name: Check test results
        run: |
          echo "ğŸ” Checking integration test results..."

          # Check if the matrix job had any failures
          if [ "${{ needs.run-integration-tests.result }}" != "success" ]; then
            echo "âŒ One or more integration tests failed"
            echo "Matrix job result: ${{ needs.run-integration-tests.result }}"
            exit 1
          else
            echo "âœ… All integration tests passed successfully"
          fi

      - name: Final status
        run: |
          echo "ğŸ‰ All tutorial agent integration tests completed successfully!"
