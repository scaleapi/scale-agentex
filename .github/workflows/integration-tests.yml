name: Run Agentex Integration Tests

permissions:
  contents: read
  packages: read

on:
  pull_request:
    paths:
      - "agentex/**"
  push:
    branches:
      - main
    paths:
      - "agentex/**"
  workflow_dispatch:
    inputs:
      commit-sha:
        description: "Commit SHA or branch to test against"
        required: true
        type: string
        default: main

jobs:
  discover-agent-images:
    name: "Discover Tutorial Agent Images"
    runs-on: ubuntu-latest
    outputs:
      agent-matrix: ${{ steps.discover.outputs.agent-matrix }}
    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # - name: Generate GitHub App Token
      #   id: generate-token
      #   uses: actions/create-github-app-token@v1
      #   with:
      #     app-id: ${{ secrets.GITHUB_APP_ID }}
      #     private-key: ${{ secrets.GITHUB_APP_PRIVATE_KEY }}
      #     owner: scaleapi

      - name: Discover tutorial agent images
        id: discover
        # env:
        #   GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          echo "üîç Building agent matrix from known tutorial agent images..."

          # Define the list of known tutorial agent packages
          PACKAGES=(
            "scale-agentex-python/tutorial-agents/00_sync-000_hello_acp"
            "scale-agentex-python/tutorial-agents/00_sync-010_multiturn"
            "scale-agentex-python/tutorial-agents/00_sync-020_streaming"
            "scale-agentex-python/tutorial-agents/10_async-00_base-000_hello_acp"
            "scale-agentex-python/tutorial-agents/10_async-00_base-010_multiturn"
            "scale-agentex-python/tutorial-agents/10_async-00_base-020_streaming"
            "scale-agentex-python/tutorial-agents/10_async-00_base-030_tracing"
            "scale-agentex-python/tutorial-agents/10_async-00_base-040_other_sdks"
            "scale-agentex-python/tutorial-agents/10_async-00_base-080_batch_events"
            "scale-agentex-python/tutorial-agents/10_async-10_temporal-000_hello_acp"
            "scale-agentex-python/tutorial-agents/10_async-10_temporal-010_agent_chat"
            "scale-agentex-python/tutorial-agents/10_async-10_temporal-020_state_machine"
            "scale-agentex-python/tutorial-agents/10_async-10_temporal-030_custom_activities"
            "scale-agentex-python/tutorial-agents/10_async-10_temporal-050_agent_chat_guardrails"
            "scale-agentex-python/tutorial-agents/10_async-10_temporal-060_open_ai_agents_sdk_hello_world"
            "scale-agentex-python/tutorial-agents/10_async-10_temporal-070_open_ai_agents_sdk_tools"
            "scale-agentex-python/tutorial-agents/10_async-10_temporal-080_open_ai_agents_sdk_human_in_the_loop"
            "scale-agentex-python/tutorial-agents/10_async-10_temporal-090_claude_agents_sdk_mvp"
          )

          # Build agent matrix from the package list
          AGENT_IMAGES="["

          for package_name in "${PACKAGES[@]}"; do
            echo "Processing package: $package_name"

            # Extract agent directory name and convert to agent name format (e.g., "000-hello-acp")
            # Pattern: [digits]_[type]-[digits]_[rest] -> [digits]-[rest]
            agent_name=$(basename "$package_name" | sed -E 's/^[0-9]+_[^-]+-([0-9]+)_(.*)$/\1-\2/' | tr '_' '-')
            echo "  - Agent name: $agent_name"

            # Add to JSON array
            if [[ "$AGENT_IMAGES" != "[" ]]; then
              AGENT_IMAGES+=","
            fi

            AGENT_IMAGES+='{"image":"ghcr.io/scaleapi/'"$package_name"':latest","agent_name":"'"$agent_name"'"}'
          done

          AGENT_IMAGES+="]"

          echo "üìã Generated agent matrix:"
          echo "$AGENT_IMAGES" | jq '.'

          # Convert to compact JSON for matrix
          echo "agent-matrix=$(echo "$AGENT_IMAGES" | jq -c '.')" >> $GITHUB_OUTPUT

  run-integration-tests:
    name: "Run Integration Tests - ${{ matrix.agent.agent_name }}"
    runs-on: ubuntu-latest
    needs: discover-agent-images
    strategy:
      fail-fast: false # Continue testing other agents even if one fails
      matrix:
        agent: ${{ fromJson(needs.discover-agent-images.outputs.agent-matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.commit-sha || github.ref }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull agent image
        run: |
          echo "üê≥ Pulling agent image: ${{ matrix.agent.image }}"
          docker pull ${{ matrix.agent.image }}
          echo "‚úÖ Agent image pulled successfully"

      - name: Start AgentEx services with host access
        working-directory: ./agentex
        run: |
          echo "üöÄ Starting AgentEx services..."
          docker compose -f docker-compose.yml up -d

          echo "üìã Initial service status:"
          docker compose ps

          echo "‚è≥ Waiting for database migrations and service initialization..."
          sleep 45  # AgentEx has 30s start_period + time for migrations

          echo "üîç Checking AgentEx service health..."
          HEALTH_TIMEOUT=90
          HEALTH_ELAPSED=0

          while [ $HEALTH_ELAPSED -lt $HEALTH_TIMEOUT ]; do
            if curl -s http://localhost:5003/health > /dev/null 2>&1; then
              echo "‚úÖ AgentEx health endpoint is responding"
              break
            fi
            echo "‚è≥ Waiting for AgentEx health check... (${HEALTH_ELAPSED}s/${HEALTH_TIMEOUT}s)"
            sleep 5
            HEALTH_ELAPSED=$((HEALTH_ELAPSED + 5))
          done

          if [ $HEALTH_ELAPSED -ge $HEALTH_TIMEOUT ]; then
            echo "‚ùå AgentEx service health check failed"
            echo "üìã AgentEx service logs:"
            docker compose logs agentex
            exit 1
          fi

          echo "üîç Verifying AgentEx API endpoints..."
          if curl -s http://localhost:5003/api > /dev/null 2>&1; then
            echo "‚úÖ AgentEx API endpoints are accessible"
          else
            echo "‚ùå AgentEx API endpoints not responding"
            echo "üìã AgentEx service logs:"
            docker compose logs agentex
            exit 1
          fi

          echo "üìã Final service status after health checks:"
          docker compose ps

      - name: Run agent integration test
        env:
          OPENAI_API_KEY: ${{ secrets.TUTORIAL_OPENAI_API_KEY }}
        run: |
          # Set variables for this agent
          AGENT_NAME="${{ matrix.agent.agent_name }}"
          AGENT_IMAGE="${{ matrix.agent.image }}"
          CONTAINER_NAME="agent-test-${AGENT_NAME}"

          echo "üß™ Running integration test for agent: ${AGENT_NAME}"
          echo "üê≥ Using image: ${AGENT_IMAGE}"

          # Determine ACP type and agent characteristics from image name
          if [[ "${AGENT_IMAGE}" == *"10_async"* ]]; then
            ACP_TYPE="async"
          else
            ACP_TYPE="sync"
          fi

          # Check if this is a Temporal agent
          if [[ "${AGENT_IMAGE}" == *"temporal"* ]]; then
            IS_TEMPORAL_AGENT=true

            # Extract queue name from agent name (e.g., "10-temporal-000-hello-acp" -> "000_hello_acp_queue")
            QUEUE_NAME=$(echo "${AGENT_NAME}" | sed -E 's/.*temporal-([0-9]+)-(.*)$/\1_\2_queue/' | tr '-' '_')
          else
            IS_TEMPORAL_AGENT=false
          fi

          # Start the agent container with appropriate configuration
          if [ "${IS_TEMPORAL_AGENT}" = true ]; then
            # Temporal agent: start both worker and ACP server
            docker run -d --name "${CONTAINER_NAME}" \
              -e ENVIRONMENT=development \
              -e AGENT_NAME="${AGENT_NAME}" \
              -e ACP_URL="http://${CONTAINER_NAME}" \
              -e ACP_PORT=8000 \
              -e ACP_TYPE="${ACP_TYPE}" \
              -e AGENTEX_BASE_URL=http://agentex:5003 \
              -e AGENTEX_API_BASE_URL=http://agentex:5003 \
              -e REDIS_URL=redis://agentex-redis:6379 \
              -e TEMPORAL_ADDRESS=agentex-temporal:7233 \
              -e TEMPORAL_HOST=agentex-temporal \
              -e AGENTEX_SERVER_TASK_QUEUE=agentex-server \
              -e WORKFLOW_NAME="${AGENT_NAME}" \
              -e WORKFLOW_TASK_QUEUE="${QUEUE_NAME}" \
              -e DATABASE_URL=postgresql://postgres:postgres@agentex-postgres:5432/agentex \
              -e MONGODB_URI=mongodb://agentex-mongodb:27017 \
              -e MONGODB_DATABASE_NAME=agentex \
              -e OPENAI_API_KEY="${OPENAI_API_KEY}" \
              -p 8000:8000 \
              --network agentex-network \
              "${AGENT_IMAGE}" \
              bash -c "python project/run_worker.py & uvicorn project.acp:acp --host 0.0.0.0 --port 8000"
          else
            # Non-temporal agent: start ACP server only
            docker run -d --name "${CONTAINER_NAME}" \
              -e ENVIRONMENT=development \
              -e AGENT_NAME="${AGENT_NAME}" \
              -e ACP_URL="http://${CONTAINER_NAME}" \
              -e ACP_PORT=8000 \
              -e ACP_TYPE="${ACP_TYPE}" \
              -e AGENTEX_BASE_URL=http://agentex:5003 \
              -e AGENTEX_API_BASE_URL=http://agentex:5003 \
              -e REDIS_URL=redis://agentex-redis:6379 \
              -e OPENAI_API_KEY="${OPENAI_API_KEY}" \
              -p 8000:8000 \
              --network agentex-network \
              "${AGENT_IMAGE}"
          fi

          # there are some agents that need npx to be installed to be run
          echo "üì¶ Installing Node.js, NPM, and NPX in agent container..."
          docker exec "${CONTAINER_NAME}" sh -c "
            set -e
            echo 'üîÑ Updating package list...'
            apt-get update -qq

            echo 'üîÑ Installing Node.js and NPM...'
            apt-get install -y -qq curl
            curl -fsSL https://deb.nodesource.com/setup_lts.x | bash -
            apt-get install -y -qq nodejs

            echo '‚úÖ Versions after installation:'
            node --version
            npm --version

          " || {
            echo "‚ùå Node.js installation failed, checking container state..."
            docker exec "${CONTAINER_NAME}" sh -c "
              echo 'Container OS info:'
              cat /etc/os-release || echo 'OS info not available'
              echo 'Available packages:'
              apt list --installed | grep node || echo 'No node packages found'
            "
            exit 1
          }

          echo "‚è≥ Waiting for agent to start..."
          sleep 10

          # Check for "Application startup complete" log message
          echo "üîç Waiting for 'Application startup complete' log message..."
          TIMEOUT=60
          ELAPSED=0

          while [ $ELAPSED -lt $TIMEOUT ]; do
            if docker logs "${CONTAINER_NAME}" 2>&1 | grep -q "Application startup complete"; then
              echo "‚úÖ Agent application has started successfully"
              break
            fi

            echo "‚è≥ Still waiting for startup... (${ELAPSED}s/${TIMEOUT}s)"
            sleep 2
            ELAPSED=$((ELAPSED + 2))
          done

          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "‚ùå Timeout waiting for 'Application startup complete' message"
            echo "üìã Container logs:"
            docker logs "${CONTAINER_NAME}"
            exit 1
          fi

          echo "üîç Waiting for agent registration with AgentEx..."
          REGISTRATION_TIMEOUT=30
          REGISTRATION_ELAPSED=0

          while [ $REGISTRATION_ELAPSED -lt $REGISTRATION_TIMEOUT ]; do
            if curl -s http://localhost:5003/agents | grep -q "${AGENT_NAME}"; then
              echo "‚úÖ Agent registered successfully"
              break
            fi
            echo "‚è≥ Waiting for registration... (${REGISTRATION_ELAPSED}s/${REGISTRATION_TIMEOUT}s)"
            sleep 5
            REGISTRATION_ELAPSED=$((REGISTRATION_ELAPSED + 5))
          done

          if [ $REGISTRATION_ELAPSED -ge $REGISTRATION_TIMEOUT ]; then
            echo "‚ùå Agent registration timeout after ${REGISTRATION_TIMEOUT}s"
            exit 1
          fi


          # Run the test inside the container with retry logic for resilience
          echo "üß™ Running tests inside the agent container with retry logic..."
          MAX_RETRIES=3
          RETRY_COUNT=0
          TEST_PASSED=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$TEST_PASSED" = false ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "üîÑ Test attempt $RETRY_COUNT/$MAX_RETRIES"

            set +e  # Don't exit on error immediately
            docker exec "${CONTAINER_NAME}" pytest tests/test_agent.py -v
            TEST_EXIT_CODE=$?
            set -e  # Re-enable exit on error

            echo "üîç Test exit code for attempt $RETRY_COUNT: $TEST_EXIT_CODE"

            # Show post-test logs after each attempt
            echo "üìã Agent logs after test attempt $RETRY_COUNT:"
            docker logs --tail=30 "${CONTAINER_NAME}"

            echo "<details><summary>üìã AgentEx logs after test attempt $RETRY_COUNT (click to expand)</summary>"
            echo ""
            echo '```'
            cd agentex && docker compose logs --tail=30 agentex
            cd ..
            echo '```'
            echo "</details>"

            if [ $TEST_EXIT_CODE -eq 0 ]; then
              echo "‚úÖ Tests passed successfully on attempt $RETRY_COUNT"
              TEST_PASSED=true
            else
              echo "‚ùå Test attempt $RETRY_COUNT failed with exit code $TEST_EXIT_CODE"
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "üîÑ Will retry in 5 seconds..."
                sleep 5
              fi
            fi
          done

          # Final result handling
          if [ "$TEST_PASSED" = true ]; then
            echo "üéâ Tests passed after $RETRY_COUNT attempts"
          else
            echo "‚ùå All $MAX_RETRIES test attempts failed"
            echo "üìã Full agent logs:"
            docker logs "${CONTAINER_NAME}"
            echo "<details><summary>üìã Full AgentEx logs (click to expand)</summary>"
            echo ""
            echo '```'
            cd agentex && docker compose logs agentex
            cd ..
            echo '```'
            echo "</details>"
            exit 1
          fi

          echo "üßπ Cleaning up container..."
          docker rm -f "${CONTAINER_NAME}"

  # Summary job to ensure the workflow fails if any test fails
  integration-tests-summary:
    name: "Integration Tests Summary"
    runs-on: ubuntu-latest
    needs: [discover-agent-images, run-integration-tests]
    if: always() # Run even if some tests fail
    steps:
      - name: Check test results
        run: |
          echo "üîç Checking integration test results..."

          # Check if the matrix job had any failures
          if [ "${{ needs.run-integration-tests.result }}" != "success" ]; then
            echo "‚ùå One or more integration tests failed"
            echo "Matrix job result: ${{ needs.run-integration-tests.result }}"
            exit 1
          else
            echo "‚úÖ All integration tests passed successfully"
          fi

      - name: Final status
        run: |
          echo "üéâ All tutorial agent integration tests completed successfully!"
